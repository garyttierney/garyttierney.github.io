{"title":"Symfony and SELinux","longTitle":"Running a Symfony application with SELinux enforcing","categories":["symfony","selinux","linux"],"timestamp":1461435089,"body":"<p>This article contains a short introduction to using SELinux to confine\nweb applications on your server.</p>\n<p>The introduction is a short and interactive tutorial, which\nyou can go through by getting the <code>Vagrantfile</code> linked at the bottom of this \n article and creating a VM. </p>\n<h3 id=\"-why-do-i-need-selinux-\"><em>Why</em> do I need SELinux?</h3>\n<p>SELinux is a great tool to secure a Linux system. It enforces <em>Mandatory\nAccess Control</em> based on a subjects assigned security context from a centrally\ncontrolled security policy. This contrasts with <em>Discretionary Access Control</em> \nwhich enforces based on the user identity and delegates authorization\ndown to the users own decisions.</p>\n<p>In <em>Mandatory Access Control</em> the system and its central policy specifies\nwhich subjects are allowed to access its objects.  In SELinux we use\nsecurity labels on subjects and objects to compute access decisions,\nand can write rules which say subjects with the type <code>gpg_t</code>\ncan access objects with the type <code>gpg_keyfile_t</code> and enforce in the policy \nthat only the GPG process can read GPG keyfiles.</p>\n<!---more-->\n<h3 id=\"getting-started\">Getting Started</h3>\n<p>To get started with confining a web application, we will first need a web \napplication to confine. A simple nginx / php-fpm stack / Symfony stack is \nsufficient for what we need to do.</p>\n<p>There won&#39;t be any exposure to RDBMS or cache servers (like MySQL or Redis,\nrespectively) but I will touch on how you can allow your web application\nto use these services all the while playing with SELinux.</p>\n<h4 id=\"setup\">Setup</h4>\n<p>To test in a development environment we need a Linux distribution\nwhich has its own maintained SELinux policy. You&#39;ll need some way to \ncreate a new CentOS 7 box. I&#39;m using Vagrant and the Vagrantfile I&#39;m using\ncan be found at the bottom of this article as a link.</p>\n<p>Once you have a virtual machine ready, the first command you want to run \nas root is:</p>\n<pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"source shell\"><span>setenforce&nbsp;0</span></span></div></pre><p><strong>don&#39;t worry, we&#39;re going to <code>setenforce 1</code> later</strong></p>\n<h4 id=\"system-dependencies\">System Dependencies</h4>\n<p>We&#39;ll need a PHP environment and web server to run our confined Symfony \napplication. I typically run with <code>php-fpm</code> and <code>nginx</code> on my systems and\nthat&#39;s what I&#39;ll be using for this example. Both <code>php-fpm</code> and <code>nginx</code> are\nalready targeted by SELinux policy in CentOS so we don&#39;t have to do any \nconfiguration here. </p>\n<pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"source shell\"><span>yum&nbsp;install&nbsp;epel-release&nbsp;</span><span class=\"comment line number-sign shell\"><span class=\"punctuation definition comment shell\"><span>#</span></span><span>&nbsp;We&nbsp;need&nbsp;EPEL&nbsp;for&nbsp;nginx</span><span>&nbsp;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span>yum&nbsp;install&nbsp;nginx&nbsp;php-common&nbsp;php-fpm&nbsp;composer</span></span></div><div class=\"line\"><span class=\"source shell\"><span>yum&nbsp;install&nbsp;policycoreutils-python&nbsp;</span><span class=\"comment line number-sign shell\"><span class=\"punctuation definition comment shell\"><span>#</span></span><span>&nbsp;SELinux&nbsp;management&nbsp;utils</span><span>&nbsp;</span></span></span></div></pre><p>We&#39;ll also need a user for our <code>php-fpm</code> processes to run under,\nso create a new user named <code>www</code> and give it the /sbin/nologin shell.</p>\n<pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"source shell\"><span>useradd&nbsp;--system&nbsp;www</span></span></div><div class=\"line\"><span class=\"source shell\"><span>chsh&nbsp;-s&nbsp;/sbin/nologin&nbsp;www</span></span></div></pre><h4 id=\"setting-up-symfony\">Setting up Symfony</h4>\n<p>After installing these dependencies we can get ourselves a copy of the Symfony\nStandard Edition, and drop it into a web directory.</p>\n<pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"source shell\"><span>mkdir&nbsp;-p&nbsp;/var/www/symfony-app</span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"support function builtin shell\"><span>cd</span></span><span>&nbsp;/var/www/symfony-app</span></span></div><div class=\"line\"><span class=\"source shell\"><span>curl&nbsp;-L&nbsp;https://github.com/symfony/symfony-standard/archive/v2.3.39.tar.gz&nbsp;</span><span class=\"keyword operator pipe shell\"><span>|</span></span><span>&nbsp;tar&nbsp;--strip&nbsp;1&nbsp;-xvz&nbsp;--</span></span></div><div class=\"line\"><span class=\"source shell\"><span>chown&nbsp;-R&nbsp;www:www&nbsp;./&nbsp;</span><span class=\"comment line number-sign shell\"><span class=\"punctuation definition comment shell\"><span>#</span></span><span>&nbsp;Fix&nbsp;permissions&nbsp;on&nbsp;this&nbsp;folder&nbsp;--&nbsp;it&nbsp;will&nbsp;be&nbsp;owned&nbsp;by&nbsp;root&nbsp;at&nbsp;this&nbsp;point</span><span>&nbsp;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span>sudo&nbsp;-u&nbsp;www&nbsp;composer&nbsp;install&nbsp;</span><span class=\"comment line number-sign shell\"><span class=\"punctuation definition comment shell\"><span>#</span></span><span>&nbsp;Run&nbsp;&quot;composer&nbsp;install&quot;&nbsp;as&nbsp;the&nbsp;www&nbsp;user,&nbsp;we&nbsp;can&#39;t&nbsp;do&nbsp;this&nbsp;in&nbsp;a&nbsp;shell&nbsp;since&nbsp;we&#39;ve&nbsp;set&nbsp;www&#39;s&nbsp;shell&nbsp;to&nbsp;/sbin/nologin</span><span>&nbsp;</span></span></span></div></pre><p>Not much is happening at this point, as we have no php-fpm, and no\nnginx. Initially our php-fpm pool will be running under the <code>apache</code>\nuser and group, so we need to update the configuration with our new user.</p>\n<pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"source shell\"><span>sed&nbsp;-i&nbsp;</span><span class=\"string quoted single shell\"><span class=\"punctuation definition string begin shell\"><span>&#39;</span></span><span>s/user&nbsp;=&nbsp;apache/user&nbsp;=&nbsp;www/</span><span class=\"punctuation definition string end shell\"><span>&#39;</span></span></span><span>&nbsp;/etc/php-fpm.d/www.conf</span></span></div><div class=\"line\"><span class=\"source shell\"><span>sed&nbsp;-i&nbsp;</span><span class=\"string quoted single shell\"><span class=\"punctuation definition string begin shell\"><span>&#39;</span></span><span>s/group&nbsp;=&nbsp;apache/group&nbsp;=&nbsp;www/</span><span class=\"punctuation definition string end shell\"><span>&#39;</span></span></span><span>&nbsp;/etc/php-fpm.d/www.conf</span></span></div></pre><p>Additionally it&#39;d be wise to turning on error reporting, so we can see\nin our browser what&#39;s causing the web server to issue an error page\nand also set a valid timezone to suppress the annoying PHP warning.</p>\n<pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"source shell\"><span class=\"support function builtin shell\"><span>echo</span></span><span>&nbsp;</span><span class=\"string quoted single shell\"><span class=\"punctuation definition string begin shell\"><span>&#39;</span></span><span>php_flag[display_errors]&nbsp;=&nbsp;on</span><span class=\"punctuation definition string end shell\"><span>&#39;</span></span></span><span>&nbsp;</span><span class=\"keyword operator redirect shell\"><span>&gt;&gt;</span></span><span>&nbsp;/etc/php-fpm.d/www.conf</span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"support function builtin shell\"><span>echo</span></span><span>&nbsp;</span><span class=\"string quoted single shell\"><span class=\"punctuation definition string begin shell\"><span>&#39;</span></span><span>date.timezone&nbsp;=&nbsp;Europe/London</span><span class=\"punctuation definition string end shell\"><span>&#39;</span></span></span><span>&nbsp;</span><span class=\"keyword operator redirect shell\"><span>&gt;&gt;</span></span><span>&nbsp;/etc/php.ini</span></span></div></pre><p>Superb. We have a working <code>php-fpm</code> configuration now, ready to use\nas soon as we have a vhost for Symfony to run under.</p>\n<p>The following step is creating an nginx configuration file which sets up\nthe vhost that we&#39;re going to be serving Symfony on. Their documentation \nprovides a good example we can use for getting started:</p>\n<pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"source shell\"><span>cat&nbsp;</span><span class=\"keyword operator redirect shell\"><span>&gt;</span></span><span>&nbsp;/etc/nginx/conf.d/symfony.conf&nbsp;</span><span class=\"string unquoted heredoc shell\"><span class=\"keyword operator heredoc shell\"><span>&lt;&lt;</span></span><span>&#39;</span><span class=\"keyword control heredoc-token shell\"><span>EOF</span></span><span>&#39;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>server&nbsp;{</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;server_name&nbsp;symfony-app.dev;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;/var/www/symfony-app/web;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;location&nbsp;/&nbsp;{</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;try&nbsp;to&nbsp;serve&nbsp;file&nbsp;directly,&nbsp;fallback&nbsp;to&nbsp;app.php</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try_files&nbsp;$uri&nbsp;/app.php$is_args$args;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;DEV</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;This&nbsp;rule&nbsp;should&nbsp;only&nbsp;be&nbsp;placed&nbsp;on&nbsp;your&nbsp;development&nbsp;environment</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;In&nbsp;production,&nbsp;don&#39;t&nbsp;include&nbsp;this&nbsp;and&nbsp;don&#39;t&nbsp;deploy&nbsp;app_dev.php&nbsp;or&nbsp;config.php</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;location&nbsp;~&nbsp;^/(app_dev|config)\\.php(/|$)&nbsp;{</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_pass&nbsp;127.0.0.1:9000;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_split_path_info&nbsp;^(.+\\.php)(/.*)$;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;fastcgi_params;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;When&nbsp;you&nbsp;are&nbsp;using&nbsp;symlinks&nbsp;to&nbsp;link&nbsp;the&nbsp;document&nbsp;root&nbsp;to&nbsp;the</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;current&nbsp;version&nbsp;of&nbsp;your&nbsp;application,&nbsp;you&nbsp;should&nbsp;pass&nbsp;the&nbsp;real</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;application&nbsp;path&nbsp;instead&nbsp;of&nbsp;the&nbsp;path&nbsp;to&nbsp;the&nbsp;symlink&nbsp;to&nbsp;PHP</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;FPM.</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Otherwise,&nbsp;PHP&#39;s&nbsp;OPcache&nbsp;may&nbsp;not&nbsp;properly&nbsp;detect&nbsp;changes&nbsp;to</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;your&nbsp;PHP&nbsp;files&nbsp;(see&nbsp;</span><span class=\"markup underline link https hyperlink\"><span>https://github.com/zendtech/ZendOptimizerPlus/issues/126</span></span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;for&nbsp;more&nbsp;information).</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_param&nbsp;SCRIPT_FILENAME&nbsp;$realpath_root$fastcgi_script_name;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_param&nbsp;DOCUMENT_ROOT&nbsp;$realpath_root;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;PROD</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;location&nbsp;~&nbsp;^/app\\.php(/|$)&nbsp;{</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_pass&nbsp;127.0.0.1:9000;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_split_path_info&nbsp;^(.+\\.php)(/.*)$;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;fastcgi_params;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;When&nbsp;you&nbsp;are&nbsp;using&nbsp;symlinks&nbsp;to&nbsp;link&nbsp;the&nbsp;document&nbsp;root&nbsp;to&nbsp;the</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;current&nbsp;version&nbsp;of&nbsp;your&nbsp;application,&nbsp;you&nbsp;should&nbsp;pass&nbsp;the&nbsp;real</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;application&nbsp;path&nbsp;instead&nbsp;of&nbsp;the&nbsp;path&nbsp;to&nbsp;the&nbsp;symlink&nbsp;to&nbsp;PHP</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;FPM.</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Otherwise,&nbsp;PHP&#39;s&nbsp;OPcache&nbsp;may&nbsp;not&nbsp;properly&nbsp;detect&nbsp;changes&nbsp;to</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;your&nbsp;PHP&nbsp;files&nbsp;(see&nbsp;</span><span class=\"markup underline link https hyperlink\"><span>https://github.com/zendtech/ZendOptimizerPlus/issues/126</span></span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;for&nbsp;more&nbsp;information).</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_param&nbsp;SCRIPT_FILENAME&nbsp;$realpath_root$fastcgi_script_name;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_param&nbsp;DOCUMENT_ROOT&nbsp;$realpath_root;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Prevents&nbsp;URIs&nbsp;that&nbsp;include&nbsp;the&nbsp;front&nbsp;controller.&nbsp;This&nbsp;will&nbsp;404:</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;</span><span class=\"markup underline link http hyperlink\"><span>http://domain.tld/app.php/some-path</span></span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Remove&nbsp;the&nbsp;internal&nbsp;directive&nbsp;to&nbsp;allow&nbsp;URIs&nbsp;like&nbsp;this</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;internal;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;error_log&nbsp;/var/log/nginx/project_error.log;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;access_log&nbsp;/var/log/nginx/project_access.log;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>}</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span class=\"keyword control heredoc-token shell\"><span>EOF</span></span></span></span></div></pre><p>This should be all we need to get traffic routed to our Symfony app.\nRestart php-fpm and nginx:</p>\n<pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"source shell\"><span>systemctl&nbsp;</span><span class=\"support function builtin shell\"><span>enable</span></span><span>&nbsp;php-fpm&nbsp;</span><span class=\"keyword operator list shell\"><span>&amp;&amp;</span></span><span>&nbsp;systemctl&nbsp;start&nbsp;php-fpm</span></span></div><div class=\"line\"><span class=\"source shell\"><span>systemctl&nbsp;</span><span class=\"support function builtin shell\"><span>enable</span></span><span>&nbsp;nginx&nbsp;</span><span class=\"keyword operator list shell\"><span>&amp;&amp;</span></span><span>&nbsp;systemctl&nbsp;start&nbsp;nginx</span></span></div></pre><p>If we hack a <code>symfony-app.dev</code> entry into the host machines <code>/etc/hosts</code> \nfile for now we will be able to access our Symfony installation. By default\nthe virtual machine listens on <code>192.168.50.59</code> so we can execute the following on the\nhost machine to set that up: <code>echo &quot;192.168.50.59 symfony-app.dev &gt;&gt; /etc/hosts&quot;</code>. </p>\n<h3 id=\"we-have-liftoff-\">We have liftoff!</h3>\n<p><img src=\"/assets/1-symfony-selinux/liftoff.png\" alt=\"liftoff!\"></p>\n<p>Now it&#39;s time to put SELinux back into enforcing mode, and see what problems\nwe have to address.</p>\n<pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"source shell\"><span>setenforce&nbsp;1</span></span></div></pre><p><img src=\"/assets/1-symfony-selinux/denied.png\" alt=\"denied :-(\"></p>\n<h3 id=\"we-have-avcs-\">We have AVCs!</h3>\n<p>The first step here is to examine what SELinux is preventing\nus from doing. We can check AVC denials by using the <code>ausearch</code>\nutility.</p>\n<pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"source shell\"><span class=\"keyword operator redirect shell\"><span>&gt;</span></span><span>&nbsp;$&nbsp;ausearch&nbsp;-m&nbsp;AVC&nbsp;-ts&nbsp;recent</span></span></div><div class=\"line\"><span class=\"source shell\"><span>----</span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"keyword other shell\"><span>time</span></span><span>-</span><span class=\"keyword operator redirect shell\"><span>&gt;</span></span><span>Tue&nbsp;Apr&nbsp;19&nbsp;18:40:54&nbsp;2016</span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"support function builtin shell\"><span>type</span></span><span>=SYSCALL&nbsp;msg=audit</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>1461105654.508:546</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>:&nbsp;arch=c000003e&nbsp;syscall=6&nbsp;success=no&nbsp;</span><span class=\"support function builtin shell\"><span>exit</span></span><span>=-13&nbsp;a0=7fff478be590&nbsp;a1=7fff478be480&nbsp;a2=7fff478be480&nbsp;a3=20&nbsp;items=0&nbsp;ppid=3915&nbsp;pid=3918&nbsp;auid=4294967295&nbsp;uid=995&nbsp;gid=993&nbsp;euid=995&nbsp;suid=995&nbsp;fsuid=995&nbsp;egid=993&nbsp;sgid=993&nbsp;fsgid=993&nbsp;tty=</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>none</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;ses=4294967295&nbsp;comm=</span><span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\"><span>&quot;</span></span><span>php-fpm</span><span class=\"punctuation definition string end shell\"><span>&quot;</span></span></span><span>&nbsp;exe=</span><span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\"><span>&quot;</span></span><span>/usr/sbin/php-fpm</span><span class=\"punctuation definition string end shell\"><span>&quot;</span></span></span><span>&nbsp;subj=system_u:system_r:httpd_t:s0&nbsp;key=</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>null</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"support function builtin shell\"><span>type</span></span><span>=AVC&nbsp;msg=audit</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>1461105654.508:546</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>:&nbsp;avc:&nbsp;denied&nbsp;</span><span class=\"meta scope group shell\"><span class=\"punctuation definition group shell\"><span>{</span></span><span>&nbsp;getattr&nbsp;}&nbsp;</span><span class=\"meta scope for-in-loop shell\"><span class=\"keyword control shell\"><span>for</span></span><span>&nbsp;</span><span class=\"variable other loop shell\"><span>pid=3918</span></span><span>&nbsp;comm=</span><span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\"><span>&quot;</span></span><span>php-fpm</span><span class=\"punctuation definition string end shell\"><span>&quot;</span></span></span><span>&nbsp;path=</span><span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\"><span>&quot;</span></span><span>/var/www/symfony-app/web/app.php</span><span class=\"punctuation definition string end shell\"><span>&quot;</span></span></span><span>&nbsp;dev=</span><span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\"><span>&quot;</span></span><span>dm-0</span><span class=\"punctuation definition string end shell\"><span>&quot;</span></span></span><span>&nbsp;ino=395144&nbsp;scontext=system_u:system_r:httpd_t:s0&nbsp;tcontext=unconfined_u:object_r:var_t:s0&nbsp;tclass=file</span></span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"meta scope group shell\"><span class=\"meta scope for-in-loop shell\"><span>----</span></span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"meta scope group shell\"><span class=\"meta scope for-in-loop shell\"><span class=\"keyword other shell\"><span>time</span></span><span>-</span><span class=\"keyword operator redirect shell\"><span>&gt;</span></span><span>Tue&nbsp;Apr&nbsp;19&nbsp;18:40:52&nbsp;2016</span></span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"meta scope group shell\"><span class=\"meta scope for-in-loop shell\"><span class=\"support function builtin shell\"><span>type</span></span><span>=SYSCALL&nbsp;msg=audit</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>1461105652.189:545</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>:&nbsp;arch=c000003e&nbsp;syscall=6&nbsp;success=no&nbsp;</span><span class=\"support function builtin shell\"><span>exit</span></span><span>=-13&nbsp;a0=7fff478be590&nbsp;a1=7fff478be480&nbsp;a2=7fff478be480&nbsp;a3=20&nbsp;items=0&nbsp;ppid=3915&nbsp;pid=3916&nbsp;auid=4294967295&nbsp;uid=995&nbsp;gid=993&nbsp;euid=995&nbsp;suid=995&nbsp;fsuid=995&nbsp;egid=993&nbsp;sgid=993&nbsp;fsgid=993&nbsp;tty=</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>none</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;ses=4294967295&nbsp;comm=</span><span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\"><span>&quot;</span></span><span>php-fpm</span><span class=\"punctuation definition string end shell\"><span>&quot;</span></span></span><span>&nbsp;exe=</span><span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\"><span>&quot;</span></span><span>/usr/sbin/php-fpm</span><span class=\"punctuation definition string end shell\"><span>&quot;</span></span></span><span>&nbsp;subj=system_u:system_r:httpd_t:s0&nbsp;key=</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>null</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span></span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"meta scope group shell\"><span class=\"meta scope for-in-loop shell\"><span class=\"support function builtin shell\"><span>type</span></span><span>=AVC&nbsp;msg=audit</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>1461105652.189:545</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>:&nbsp;avc:&nbsp;denied&nbsp;</span><span class=\"meta scope group shell\"><span class=\"punctuation definition group shell\"><span>{</span></span><span>&nbsp;getattr&nbsp;}&nbsp;</span><span class=\"meta scope for-in-loop shell\"><span class=\"keyword control shell\"><span>for</span></span><span>&nbsp;</span><span class=\"variable other loop shell\"><span>pid=3916</span></span><span>&nbsp;comm=</span><span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\"><span>&quot;</span></span><span>php-fpm</span><span class=\"punctuation definition string end shell\"><span>&quot;</span></span></span><span>&nbsp;path=</span><span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\"><span>&quot;</span></span><span>/var/www/symfony-app/web/app.php</span><span class=\"punctuation definition string end shell\"><span>&quot;</span></span></span><span>&nbsp;dev=</span><span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\"><span>&quot;</span></span><span>dm-0</span><span class=\"punctuation definition string end shell\"><span>&quot;</span></span></span><span>&nbsp;ino=395144&nbsp;scontext=system_u:system_r:httpd_t:s0&nbsp;tcontext=unconfined_u:object_r:var_t:s0&nbsp;tclass=file</span></span></span></span></span></span></div></pre><p>Ouch! What does this mean to us? Well currently our web directory is\nlabeled with the file context <code>var_t</code>. This seems like it isn&#39;t suitable\nfor httpd content. Though this seems like a pretty common\npath to store files for web applications. Let&#39;s see what this path\n<em>should</em> be labeled as according to the loaded SELinux policy.</p>\n<pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"source shell\"><span class=\"keyword operator redirect shell\"><span>&gt;</span></span><span>&nbsp;$&nbsp;matchpathcon&nbsp;/var/www</span></span></div><div class=\"line\"><span class=\"source shell\"><span>/var/www&nbsp;system_u:object_r:httpd_sys_content_t:s0</span></span></div></pre><p>That&#39;s weird. Then why is it currently labeled as <code>var_t</code>? The \nanswer is that we didn&#39;t tell <code>mkdir</code> to use the default\nfile contexts for this path when we created the directory,\nso the context was inherited from /var.</p>\n<p>We can fix this by using the <code>restorecon</code> utility, which \nfixes file contexts to what they should be according to policy.</p>\n<pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"source shell\"><span>restorecon&nbsp;-R&nbsp;/var/www</span></span></div></pre><p>That gets by the first set of errors, but this is now where we really\nneed to consider what our app can and can&#39;t do. If we rm the cache and \nvisit our Symfony app again it&#39;ll complain that it does not\nhave permissions to write to the cache. </p>\n<p>Warming the cache worked the first time because we ran <code>composer install</code>\nin an <code>unconfined</code> user shell. However, to let scripts running in the\n<code>httpd_t</code> domain write to the cache we will have to start modifying policy.\nFortunately we already have a file context defined for writable\nhttpd content in the <a href=\"https://github.com/fedora-selinux/selinux-policy/blob/rawhide-contrib/apache.te#L411\">upstream policy</a>.</p>\n<p>We can relabel and fix the cache directory with this context by running:</p>\n<pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"source shell\"><span>semanage&nbsp;fcontext&nbsp;-a&nbsp;-t&nbsp;httpd_sys_rw_content_t&nbsp;</span><span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\"><span>&quot;</span></span><span>/var/www/symfony-app/cache(/.*)?</span><span class=\"punctuation definition string end shell\"><span>&quot;</span></span></span></span></div><div class=\"line\"><span class=\"source shell\"><span>restorecon&nbsp;-R&nbsp;/var/www/symfony-app/cache</span></span></div></pre><p>Now we&#39;re back in business! Our <code>/var/www/symfony-app/logs</code> has already\nbeen labeled for log files by an existing file context so we don&#39;t need\nto bother with that.</p>\n<p>That about concludes this introduction to Symfony with SELinux. There&#39;s\nmore we could do to secure our application and some more considerations\n(like cron) but now you can run Symfony applications without turning\nSELinux off, which is a great step forward!</p>\n<h3 id=\"extras\">Extras</h3>\n<h4 id=\"i-can-t-connect-to-mysql-or-redis\">I can&#39;t connect to MySQL or Redis</h4>\n<p>This problem comes from the SELinux policy\npreventing httpd&#39;s from connecting to anywhere on the network (the\nconnection to php-fpm is allowed because port 9000 is labeled as a\nhttpd port).</p>\n<p>Since this is such a common use case SELinux presents a mechanism\nto allow for toggleable policy. We can see which booleans we can\ntoggle for the httpd policy by running:</p>\n<pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"source shell\"><span class=\"keyword operator redirect shell\"><span>&gt;</span></span><span>&nbsp;$&nbsp;semanage&nbsp;boolean&nbsp;-l&nbsp;</span><span class=\"keyword operator pipe shell\"><span>|</span></span><span>&nbsp;grep&nbsp;</span><span class=\"string quoted single shell\"><span class=\"punctuation definition string begin shell\"><span>&#39;</span></span><span>httpd</span><span class=\"punctuation definition string end shell\"><span>&#39;</span></span></span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_can_network_relay&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;can&nbsp;network&nbsp;relay</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_can_connect_mythtv&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;can&nbsp;connect&nbsp;mythtv</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_can_network_connect_db&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;can&nbsp;network&nbsp;connect&nbsp;db</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_use_gpg&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;use&nbsp;gpg</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_dbus_sssd&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;dbus&nbsp;sssd</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_enable_cgi&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>on&nbsp;,&nbsp;on</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;</span><span class=\"support function builtin shell\"><span>enable</span></span><span>&nbsp;cgi</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_verify_dns&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;verify&nbsp;dns</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_dontaudit_search_dirs&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;dontaudit&nbsp;search&nbsp;</span><span class=\"support function builtin shell\"><span>dirs</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_anon_write&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;anon&nbsp;write</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_use_cifs&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;use&nbsp;cifs</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_enable_homedirs&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;</span><span class=\"support function builtin shell\"><span>enable</span></span><span>&nbsp;homedirs</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_unified&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;unified</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_mod_auth_pam&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;mod&nbsp;auth&nbsp;pam</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_run_stickshift&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;run&nbsp;stickshift</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_use_fusefs&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;use&nbsp;fusefs</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_can_connect_ldap&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;can&nbsp;connect&nbsp;ldap</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_can_network_connect&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;can&nbsp;network&nbsp;connect</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_mod_auth_ntlm_winbind&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;mod&nbsp;auth&nbsp;ntlm&nbsp;winbind</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_tty_comm&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;tty&nbsp;comm</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_sys_script_anon_write&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;sys&nbsp;script&nbsp;anon&nbsp;write</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_graceful_shutdown&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>on&nbsp;,&nbsp;on</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;graceful&nbsp;shutdown</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_can_connect_ftp&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;can&nbsp;connect&nbsp;ftp</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_run_ipa&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;run&nbsp;ipa</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_read_user_content&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;</span><span class=\"support function builtin shell\"><span>read</span></span><span>&nbsp;user&nbsp;content</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_use_nfs&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;use&nbsp;nfs</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_can_connect_zabbix&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;can&nbsp;connect&nbsp;zabbix</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_tmp_exec&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;tmp&nbsp;</span><span class=\"support function builtin shell\"><span>exec</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_run_preupgrade&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;run&nbsp;preupgrade</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_manage_ipa&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;manage&nbsp;ipa</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_can_sendmail&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;can&nbsp;sendmail</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_builtin_scripting&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>on&nbsp;,&nbsp;on</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;</span><span class=\"support function builtin shell\"><span>builtin</span></span><span>&nbsp;scripting</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_dbus_avahi&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;dbus&nbsp;avahi</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_can_check_spam&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;can&nbsp;check&nbsp;spam</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_can_network_memcache&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;can&nbsp;network&nbsp;memcache</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_can_network_connect_cobbler&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;can&nbsp;network&nbsp;connect&nbsp;cobbler</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_use_sasl&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;use&nbsp;sasl</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_serve_cobbler_files&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;serve&nbsp;cobbler&nbsp;files</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_execmem&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;execmem</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_ssi_exec&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;ssi&nbsp;</span><span class=\"support function builtin shell\"><span>exec</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_use_openstack&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;use&nbsp;openstack</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_enable_ftp_server&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;</span><span class=\"support function builtin shell\"><span>enable</span></span><span>&nbsp;ftp&nbsp;server</span></span></div><div class=\"line\"><span class=\"source shell\"><span>httpd_setrlimit&nbsp;</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>off&nbsp;,&nbsp;off</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;Allow&nbsp;httpd&nbsp;to&nbsp;setrlimit</span></span></div></pre><p>The <code>httpd_can_network_connect_db</code> boolean sounds like it \nshould do the job if you only need to connect to a database.\nIf this doesn&#39;t cover your use cases you can use the more general\n<code>httpd_can_network_connect</code> to allow connections to any service.</p>\n<p>To toggle these booleans we run:</p>\n<pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"source shell\"><span>setsebool&nbsp;-P&nbsp;httpd_can_network_connect_db&nbsp;1</span></span></div></pre><p>The <code>-P</code> flag we pass tells setsetbool to persist this change so it\nis applied whenever policy reloads or the machine is rebooted.</p>\n<h4 id=\"this-doesn-t-work-with-php7-\">This doesn&#39;t work with PHP7!</h4>\n<p>PHP7 came with some pretty huge engine improvements, along with superior\nJIT compilation. To allow PHP7 to do this compilation we need to allow\n<code>httpd_t</code> access to the <code>execmem</code> permission. Fortunately, there is\nalso a boolean for this and we can enable it by running:</p>\n<pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"source shell\"><span>setsebool&nbsp;-P&nbsp;httpd_can_execmem&nbsp;1</span></span></div></pre><h4 id=\"how-can-i-avoid-the-issue-you-ran-into-with-mkdir-\">How can I avoid the issue you ran into with <code>mkdir</code>?</h4>\n<p>This is pretty simple to accomplish. <code>coreutils</code> packages that move, or\ncreate files typically allow you to specify a <code>-Z</code> option which\nindicates that the matching file context for the target path\nshould be assigned to the new file.</p>\n<h4 id=\"what-if-someone-hijacks-the-web-server-process-running-under-root-aren-t-i-screwed-anyway-\">What if someone hijacks the web server process running under <code>root</code>? Aren&#39;t I screwed anyway?</h4>\n<p>No! The httpd_t domain only has access to whatever the \npolicy explicitly granted to it. Even if we&#39;re running\nas root, if we&#39;re not associated with the correct security context\nto access the target file then we wil be denied access.</p>\n<p>Example (as root):</p>\n<pre class=\"editor editor-colors\"><div class=\"line\"><span class=\"source shell\"><span class=\"keyword operator redirect shell\"><span>&gt;</span></span><span>&nbsp;$&nbsp;cat&nbsp;</span><span class=\"keyword operator redirect shell\"><span>&gt;</span></span><span>&nbsp;</span><span class=\"support function builtin shell\"><span>test</span></span><span>.c&nbsp;</span><span class=\"string unquoted heredoc shell\"><span class=\"keyword operator heredoc shell\"><span>&lt;&lt;</span></span><span>&#39;</span><span class=\"keyword control heredoc-token shell\"><span>EOF</span></span><span>&#39;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>#include&nbsp;&lt;stdlib.h&gt;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>#include&nbsp;&lt;stdio.h&gt;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>#include&nbsp;&lt;stddef.h&gt;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>int&nbsp;main(int&nbsp;argc,&nbsp;char&nbsp;*argv)&nbsp;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>{</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;FILE&nbsp;*file&nbsp;=&nbsp;fopen(&quot;/etc/shadow&quot;,&nbsp;&quot;r&quot;);</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(file&nbsp;==&nbsp;NULL)&nbsp;{</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;We&#39;ve&nbsp;been&nbsp;thwarted!\\n&quot;);</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-1;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;fclose(file);</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span>}</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"string unquoted heredoc shell\"><span class=\"keyword control heredoc-token shell\"><span>EOF</span></span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"keyword operator redirect shell\"><span>&gt;</span></span><span>&nbsp;$&nbsp;gcc&nbsp;</span><span class=\"support function builtin shell\"><span>test</span></span><span>.c&nbsp;-o&nbsp;</span><span class=\"support function builtin shell\"><span>test</span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"keyword operator redirect shell\"><span>&gt;</span></span><span>&nbsp;$&nbsp;chcon&nbsp;</span><span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\"><span>&quot;</span></span><span>system_u:object_r:httpd_exec_t</span><span class=\"punctuation definition string end shell\"><span>&quot;</span></span></span><span>&nbsp;./test</span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"keyword operator redirect shell\"><span>&gt;</span></span><span>&nbsp;$&nbsp;runcon&nbsp;</span><span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\"><span>&quot;</span></span><span>system_u:object_r:httpd_t:s0</span><span class=\"punctuation definition string end shell\"><span>&quot;</span></span></span><span>&nbsp;./test</span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"keyword operator redirect shell\"><span>&gt;</span></span><span>&nbsp;$&nbsp;ausearch&nbsp;-m&nbsp;AVC&nbsp;-ts&nbsp;recent</span></span></div><div class=\"line\"><span class=\"source shell\"><span>----</span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"keyword other shell\"><span>time</span></span><span>-</span><span class=\"keyword operator redirect shell\"><span>&gt;</span></span><span>Tue&nbsp;Apr&nbsp;19&nbsp;20:24:53&nbsp;2016</span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"support function builtin shell\"><span>type</span></span><span>=SYSCALL&nbsp;msg=audit</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>1461111893.503:603</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>:&nbsp;arch=c000003e&nbsp;syscall=2&nbsp;success=no&nbsp;</span><span class=\"support function builtin shell\"><span>exit</span></span><span>=-13&nbsp;a0=4006a2&nbsp;a1=0&nbsp;a2=1b6&nbsp;a3=21000&nbsp;items=0&nbsp;ppid=2817&nbsp;pid=4495&nbsp;auid=1000&nbsp;uid=0&nbsp;gid=0&nbsp;euid=0&nbsp;suid=0&nbsp;fsuid=0&nbsp;egid=0&nbsp;sgid=0&nbsp;fsgid=0&nbsp;tty=</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>none</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>&nbsp;ses=4&nbsp;comm=</span><span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\"><span>&quot;</span></span><span>test</span><span class=\"punctuation definition string end shell\"><span>&quot;</span></span></span><span>&nbsp;exe=</span><span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\"><span>&quot;</span></span><span>/var/www/symfony-app/app/test</span><span class=\"punctuation definition string end shell\"><span>&quot;</span></span></span><span>&nbsp;subj=system_u:system_r:httpd_t:s0&nbsp;key=</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>null</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span></span></div><div class=\"line\"><span class=\"source shell\"><span class=\"support function builtin shell\"><span>type</span></span><span>=AVC&nbsp;msg=audit</span><span class=\"meta scope subshell shell\"><span class=\"punctuation definition subshell shell\"><span>(</span></span><span>1461111893.503:603</span><span class=\"punctuation definition subshell shell\"><span>)</span></span></span><span>:&nbsp;avc:&nbsp;&nbsp;denied&nbsp;&nbsp;</span><span class=\"meta scope group shell\"><span class=\"punctuation definition group shell\"><span>{</span></span><span>&nbsp;</span><span class=\"support function builtin shell\"><span>read</span></span><span>&nbsp;}&nbsp;</span><span class=\"meta scope for-in-loop shell\"><span class=\"keyword control shell\"><span>for</span></span><span>&nbsp;&nbsp;</span><span class=\"variable other loop shell\"><span>pid=4495</span></span><span>&nbsp;comm=</span><span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\"><span>&quot;</span></span><span>test</span><span class=\"punctuation definition string end shell\"><span>&quot;</span></span></span><span>&nbsp;name=</span><span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\"><span>&quot;</span></span><span>shadow</span><span class=\"punctuation definition string end shell\"><span>&quot;</span></span></span><span>&nbsp;dev=</span><span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\"><span>&quot;</span></span><span>dm-0</span><span class=\"punctuation definition string end shell\"><span>&quot;</span></span></span><span>&nbsp;ino=1967275&nbsp;scontext=system_u:system_r:httpd_t:s0&nbsp;tcontext=system_u:object_r:shadow_t:s0&nbsp;tclass=file</span></span></span></span></div></pre><p>If you have any questions and want to get in touch don&#39;t hesitate to! Just\nsee my <a href=\"/contact.html\">contact</a> page.</p>\n","readingTime":"18 min read","summary":"<p>This article contains a short introduction to using SELinux to confine\nweb applications on your server.</p>\n<p>The introduction is a short and interactive tutorial, which\nyou can go through by getting the <code>Vagrantfile</code> linked at the bottom of this \n article and creating a VM. </p>\n<h3 id=\"-why-do-i-need-selinux-\"><em>Why</em> do I need SELinux?</h3>\n<p>SELinux is a great tool to secure a Linux system. It enforces <em>Mandatory\nAccess Control</em> based on a subjects assigned security context from a centrally\ncontrolled security policy. This contrasts with <em>Discretionary Access Control</em> \nwhich enforces based on the user identity and delegates authorization\ndown to the users own decisions.</p>\n<p>In <em>Mandatory Access Control</em> the system and its central policy specifies\nwhich subjects are allowed to access its objects.  In SELinux we use\nsecurity labels on subjects and objects to compute access decisions,\nand can write rules which say subjects with the type <code>gpg_t</code>\ncan access objects with the type <code>gpg_keyfile_t</code> and enforce in the policy \nthat only the GPG process can read GPG keyfiles.</p>\n"}